upstream frontend_app {
    server 127.0.0.1:3000;
}

upstream tenant_website {
    server 127.0.0.1:3001;
}

upstream tenant_website_realestate {
    server 127.0.0.1:3001;
}

upstream tenant_website_ecommerce {
    server 127.0.0.1:3002;
}

upstream tenant_website_tourism {
    server 127.0.0.1:3003;
}

upstream backend_api {
    server 127.0.0.1:8080;
}

map $tenant_product $tenant_frontend_upstream {
    default http://tenant_website_realestate;
    realestate http://tenant_website_realestate;
    ecommerce http://tenant_website_ecommerce;
    tourism http://tenant_website_tourism;
}

# Root domain: redirect apex to www (HTTP + HTTPS)
server {
    listen 80;
    listen [::]:80;
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name luxury-uaeproperty.com;

    ssl_certificate /etc/letsencrypt/live/luxury-uaeproperty.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/luxury-uaeproperty.com/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    return 301 https://www.luxury-uaeproperty.com$request_uri;
}

# www root: HTTP -> HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name www.luxury-uaeproperty.com;
    return 301 https://www.luxury-uaeproperty.com$request_uri;
}

# www root: HTTPS app (port 3000)
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name www.luxury-uaeproperty.com;

    ssl_certificate /etc/letsencrypt/live/luxury-uaeproperty.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/luxury-uaeproperty.com/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    client_max_body_size 50M;

    location /api/ {
        proxy_pass http://backend_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Origin $http_origin;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_cache_bypass $http_upgrade;
    }

    location / {
        proxy_pass http://frontend_app;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Origin $http_origin;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_cache_bypass $http_upgrade;
    }
}

# API host
server {
    listen 80;
    listen [::]:80;
    server_name api.luxury-uaeproperty.com;
    return 301 https://api.luxury-uaeproperty.com$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name api.luxury-uaeproperty.com;

    ssl_certificate /etc/letsencrypt/live/api.luxury-uaeproperty.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.luxury-uaeproperty.com/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location / {
        proxy_pass http://backend_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
    }
}

# Tenant subdomains: HTTP -> HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name ~^(?!(www|api)$)(?<tenant>[a-z0-9-]+)\.luxury-uaeproperty\.com$;
    return 301 https://$host$request_uri;
}

# Tenant subdomains: HTTPS (wildcard cert, port 3001)
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name ~^(?!(www|api)$)(?<tenant>[a-z0-9-]+)\.luxury-uaeproperty\.com$;

    ssl_certificate /etc/letsencrypt/live/luxury-uaeproperty.com-wildcard/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/luxury-uaeproperty.com-wildcard/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    client_max_body_size 50M;

    location = /_tenant_product_resolve {
        internal;
        proxy_pass http://backend_api/api/public/tenant-product?subdomain=$tenant;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Tenant-Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/ {
        proxy_pass http://backend_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Origin $http_origin;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_cache_bypass $http_upgrade;
    }

    location / {
        auth_request /_tenant_product_resolve;
        auth_request_set $tenant_product $upstream_http_x_tenant_product;
        proxy_pass $tenant_frontend_upstream;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Origin $http_origin;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_cache_bypass $http_upgrade;
    }
}
